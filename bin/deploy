#!/bin/bash

if ! kubectl get ns concourse 2>/dev/null; then
  cat <<EOF | kubectl apply -f -
---
apiVersion: v1
kind: Namespace
metadata:
  name: concourse
  labels:
    quarks.cloudfoundry.org/monitored: concourse
EOF
fi

if [[ ${PROJECT_REGION:-"unset"} == "unset" ]]; then
  echo "Please set environment variable \"PROJECT_REGION\" to the desired region."
  echo "For a list of all regions, see https://cloud.google.com/compute/docs/regions-zones"
  exit 1
fi

PROJECT_ID=$(gcloud config get-value core/project 2>/dev/null)

echo "Using GCP project \"$PROJECT_ID\" and region \"$PROJECT_REGION\" for deployment..."
kapp deploy -c -a concourse -n concourse -f <(ytt -f config --data-value google.project_id="$PROJECT_ID" --data-value google.region="$PROJECT_REGION")
